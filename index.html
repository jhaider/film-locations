<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  font: 300 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
  fill: #bbb;
}

.node:hover {
  fill: #000;
}

.link {
  stroke: rgb(180,110,245);
  stroke-opacity: .4;
  fill: none;
  pointer-events: none;
}

.node:hover,
.node--source,
.node--target {
  font-weight: 700;
}

.node--source {
  fill: rgb(25,163,131);
}

.node--target {
  fill: rgb(68,55,239);
}

.link--source,
.link--target {
  stroke-opacity: 1;
  stroke-width: 2px;
}

.link--source {
  stroke: rgb(68,55,239);
}

.link--target {
  stroke: rgb(25,163,131);
}

</style>
<div id="bundle-diagram"></div>
<div id="pie-chart"></div>

<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="http://rawgithub.com/desmosinc/scrubber/master/scrubber.js"></script>
<script src="js/third-party-helper.js"></script>
<link rel="stylesheet" href="http://rawgithub.com/desmosinc/scrubber/master/scrubber.css">
<script>

var diameter = 700,//960,
    radius = diameter / 2,
    innerRadius = radius - 120;

var cluster = d3.layout.cluster()
    .size([360, innerRadius])
    .sort(null)
    .value(function(d) { return d.size; });

var bundle = d3.layout.bundle();

var line = d3.svg.line.radial()
    .interpolate("bundle")
    .tension(.85)
    .radius(function(d) { return d.y; })
    .angle(function(d) { return d.x / 180 * Math.PI; });

var svg, link, node;
var TITLE_INDEX = 8;
var YEAR_INDEX = 9;
var LOCATION_INDEX = 10;
var MOVIE_STRING = "Movie..";
var LOCATION_STRING = "Location..";
var mapByYear = null;
var locationToNeighborhood = {};
var totalMovies = 0;
var scrubber = new ScrubberView();
var minYear, maxYear;
var years = null;
var display = document.createElement('div');
var bundleDiagram = document.getElementById("bundle-diagram");
bundleDiagram.appendChild(display);
getLocationMap();

function getLocationMap() {
  var url = "https://raw.githubusercontent.com/jhaider/film-locations/master/json/locationToNeighborhood.json";
  var request = new XMLHttpRequest();

  request.addEventListener('load', locationHoodComplete);
  request.open("get", url, true);
  request.send();
}

function locationHoodComplete(event) {
  locationToNeighborhood = JSON.parse(this.responseText);
  d3.json("json/film_locations.json", function(error, filmData) {
    if (error) throw error;
    getSources(filmData);
    display.innerHTML = "Year Displayed: 2015";
  });
}

function initializeScrubber() {
  bundleDiagram.appendChild(scrubber.elt);
  scrubber.min(1);
  scrubber.max(years.length);
  scrubber.step(1);
  scrubber.value(years.length);
  scrubber.orientation('horizontal'); // 'horizontal'
  scrubber.elt.style["width"] = "600px";
}

scrubber.onValueChanged = function (value) {
  display.innerHTML = "Year Displayed: " + years[value - 1];
  buildDiagramForYear(years[value - 1]);
}

function buildDiagramForYear(year) {
  d3.select("svg").remove();   // Clear previous diagram
  svg = d3.select("#bundle-diagram").append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
    .append("g")
    .attr("transform", "translate(" + radius + "," + radius + ")");

  link = svg.append("g").selectAll(".link");
  node = svg.append("g").selectAll(".node");

  if (mapByYear[year]) {
    var nodes = cluster.nodes(packageHierarchy(mapByYear[year])),
        links = packageImports(nodes);

    link = link
        .data(bundle(links))
      .enter().append("path")
        .each(function(d) { d.source = d[0], d.target = d[d.length - 1]; })
        .attr("class", "link")
        .attr("d", line);

    node = node
        .data(nodes.filter(function(n) { return !n.children; }))
      .enter().append("text")
        .attr("class", "node")
        .attr("dy", ".31em")
        .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
        .style("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
        .text(function(d) { return d.key; })
        .on("mouseover", mouseovered)
        .on("mouseout", mouseouted);
  }
}

d3.select(self.frameElement).style("height", diameter + "px");

function getSources(filmData) {
  var linkMap = {};
  mapByYear = {};
  minYear = "2222";
  maxYear = "0";

  filmData["data"].forEach(function (row) {
    if (row[LOCATION_INDEX]) {
      var title = MOVIE_STRING + row[TITLE_INDEX];
      var listedLocation = locationToNeighborhood[row[LOCATION_INDEX]];
      var location = LOCATION_STRING + locationToNeighborhood[row[LOCATION_INDEX]];
      var year = row[YEAR_INDEX];
      if (year < minYear) {
        minYear = year;
      }
      if (year > maxYear) {
        maxYear = year;
      }
      if (!linkMap[year]) {
        linkMap[year] = {};
      }
      // Initialize
      if (!linkMap[year][title]) {
        totalMovies++;
        linkMap[year][title] = {name: title, "imports": []};
      }
      // Check duplicate locations
      if (linkMap[year][title].imports.indexOf(location) == -1) {
        linkMap[year][title].imports.push(location);
      }
      // Initialize
      if (!linkMap[year][location]) {
        linkMap[year][location] = {name: location, "imports": []};
      }
      linkMap[year][location].imports.push(title);
    }
  });

  for (var year in linkMap) {
    mapByYear[year] = Object.keys(linkMap[year]).map(function (key) {
      return linkMap[year][key];
    });
  }

  years = Object.keys(mapByYear);
  initializeScrubber();
}
</script>