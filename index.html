<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Film Locations in the Bay</title>
  <style>
    .background {
      fill: none;
      pointer-events: all;
    }

    #counties {
      fill: #aaa;
    }

    #counties .active {
      fill: #663366;
    }

    .county-borders {
      fill: rgb(204,177,204);
    }

  </style>
</head>
<body>
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript">
    // Initialization
    var width = 500;
    var height = 450;
    var centered = null;
    var g, path;
    var filmData = null;

    initializeMap();
    getFilmData();

    // Regex from http://stackoverflow.com/questions/2332811/capitalize-words-in-string/7592235#7592235
    String.prototype.capitalize = function(lower) {
      var lowerCased = this.toLowerCase();
      return lowerCased.replace(/(?:^|\s)\S/g, function(a) { 
        return a.toUpperCase(); });
    };

    function initializeMap() {
      // Define map projection (adapted from base adjustments from here:
      // https://github.com/mbostock/d3/wiki/Geo-Projections)
      var projection = d3.geo.albers()
                        .center([-0.6, 38.7])
                        .rotate([96,0])
                        .parallels([29.5, 45.5])
                        .scale(10000)
                        .translate([width * 7.35, height * 1.25]);

      // Define path generator
      path = d3.geo.path()
                  .projection(projection);

      // Create SVG element
      var svg = d3.select("body")
                  .append("svg")
                  .attr("width", width)
                  .attr("height", height);

      // Add attributes and click handler
      svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height)
        .on("click", clicked);

      g = svg.append("g");
      g.attr("background")

      // Load in GeoJSON data
      d3.json("json/san_francisco.geo.json", function(error, json) {
          if (error) return console.error(error);

          // Create one clickable target per GeoJSON feature
          g.append("g")
            .attr("id", "counties")
            .selectAll("path")
            .data(json.features)
            .enter().append("path")
            .attr("d", path)
            .on("click", clicked);

          // Bind data and create one path per GeoJSON feature
          g.selectAll("path")
             .data(json.features)
             .attr("class", "county-borders")
             .attr("d", path);
      });
    }

    // clicked logic from http://bl.ocks.org/mbostock/2206590
    function clicked(object) {
      var x, y, k;

      if (object && centered !== object) {
        var centroid = path.centroid(object);
        x = centroid[0];
        y = centroid[1];
        k = 4;
        centered = object;
        changeSelectedText(object);
      } else {
        x = width / 2;
        y = height / 2;
        k = 1;
        centered = null;
        changeSelectedText(null);
      }

      g.selectAll("path")
        .classed("active", centered && function(object) { return object === centered; });

      g.transition()
        .duration(750)
        .attr("transform", "translate(" + width / 2 + "," +
              height / 2 + ")scale(" + k + ")translate(" + (-x) + "," + (-y) + ")")
        .style("stroke-width", 1.5 / k + "px");
    }

    function getFilmData() {
      var url = "https://data.sfgov.org/api/views/yitu-d5am/rows.json";
      var request = new XMLHttpRequest();

      request.addEventListener('load', requestComplete);
      request.open("get", url, true);
      request.send();
    }

    function requestComplete(event) {
      console.log(this.responseText);
      filmData = this.responseText;
    }

    function changeSelectedText(object) {
      var location = "Nothing selected.";
      var textBox = document.getElementById("selected-county-text");

      if (object) {
        location = object.properties.name.capitalize() + ", " + object.properties.county;  
      }

      textBox.textContent = location;
    }

  </script>

  <div id="selected-county-text">Nothing selected.</div>
</body>
</html>